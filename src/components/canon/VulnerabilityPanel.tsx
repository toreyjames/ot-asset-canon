"use client";

import { useState } from "react";
import type { CanonAsset } from "@/types/canon";

interface CVEResult {
  cveId: string;
  description: string;
  cvssV3Score: number | null;
  cvssV3Severity: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW" | null;
  attackVector: string | null;
  published: string;
  epssScore: number | null;
  inKEV: boolean;
}

interface AssetVulnerabilityEnrichment {
  assetId: string;
  tagNumber: string;
  vendor: string;
  model: string;
  totalCVEs: number;
  criticalCount: number;
  highCount: number;
  mediumCount: number;
  lowCount: number;
  kevCount: number;
  maxEPSS: number;
  riskTier: "critical" | "high" | "medium" | "low";
  topCVEs: CVEResult[];
  lastEnriched: string;
}

interface VulnerabilitySummary {
  totalAssets: number;
  enrichedAssets: number;
  totalCVEs: number;
  criticalCVEs: number;
  highCVEs: number;
  kevCVEs: number;
  criticalAssets: number;
  highAssets: number;
  topVulnerableAssets: {
    tagNumber: string;
    vendor: string;
    totalCVEs: number;
    criticalCount: number;
    kevCount: number;
    riskTier: string;
  }[];
}

interface VulnerabilityPanelProps {
  assets: Partial<CanonAsset>[];
  onAssetSelect?: (asset: Partial<CanonAsset>) => void;
}

const SEVERITY_COLORS = {
  CRITICAL: "bg-red-600 text-white",
  HIGH: "bg-orange-500 text-white",
  MEDIUM: "bg-yellow-500 text-black",
  LOW: "bg-blue-400 text-white",
};

const TIER_COLORS = {
  critical: "bg-red-100 text-red-800 border-red-300",
  high: "bg-orange-100 text-orange-800 border-orange-300",
  medium: "bg-yellow-100 text-yellow-800 border-yellow-300",
  low: "bg-green-100 text-green-800 border-green-300",
};

export default function VulnerabilityPanel({
  assets,
  onAssetSelect,
}: VulnerabilityPanelProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [progress, setProgress] = useState({ current: 0, total: 0 });
  const [enrichments, setEnrichments] = useState<AssetVulnerabilityEnrichment[]>([]);
  const [summary, setSummary] = useState<VulnerabilitySummary | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [selectedEnrichment, setSelectedEnrichment] = useState<AssetVulnerabilityEnrichment | null>(null);

  // Filter assets that can be enriched (have vendor info)
  const enrichableAssets = assets.filter(
    (a) =>
      a.controlSystem?.controllerMake ||
      a.network?.manufacturer
  );

  const handleEnrich = async () => {
    setIsLoading(true);
    setError(null);
    setProgress({ current: 0, total: enrichableAssets.length });

    try {
      // Send assets in batches to avoid timeout
      const batchSize = 5;
      const allEnrichments: AssetVulnerabilityEnrichment[] = [];

      for (let i = 0; i < enrichableAssets.length; i += batchSize) {
        const batch = enrichableAssets.slice(i, i + batchSize);

        const response = await fetch("/api/vulnerabilities", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ assets: batch }),
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        allEnrichments.push(...data.enrichments);

        setProgress({ current: i + batch.length, total: enrichableAssets.length });

        // Wait between batches to respect rate limits
        if (i + batchSize < enrichableAssets.length) {
          await new Promise((resolve) => setTimeout(resolve, 2000));
        }
      }

      setEnrichments(allEnrichments);

      // Calculate summary from all enrichments
      const totalCVEs = allEnrichments.reduce((sum, e) => sum + e.totalCVEs, 0);
      const criticalCVEs = allEnrichments.reduce((sum, e) => sum + e.criticalCount, 0);
      const highCVEs = allEnrichments.reduce((sum, e) => sum + e.highCount, 0);
      const kevCVEs = allEnrichments.reduce((sum, e) => sum + e.kevCount, 0);

      setSummary({
        totalAssets: allEnrichments.length,
        enrichedAssets: allEnrichments.filter((e) => e.totalCVEs > 0).length,
        totalCVEs,
        criticalCVEs,
        highCVEs,
        kevCVEs,
        criticalAssets: allEnrichments.filter((e) => e.riskTier === "critical").length,
        highAssets: allEnrichments.filter((e) => e.riskTier === "high").length,
        topVulnerableAssets: [...allEnrichments]
          .sort((a, b) => b.totalCVEs - a.totalCVEs)
          .slice(0, 10)
          .map((e) => ({
            tagNumber: e.tagNumber,
            vendor: e.vendor,
            totalCVEs: e.totalCVEs,
            criticalCount: e.criticalCount,
            kevCount: e.kevCount,
            riskTier: e.riskTier,
          })),
      });
    } catch (err) {
      setError(err instanceof Error ? err.message : "Enrichment failed");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
      {/* Header */}
      <div className="p-4 border-b border-gray-200 dark:border-gray-700">
        <div className="flex items-center justify-between">
          <div>
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
              Vulnerability Intelligence
            </h3>
            <p className="text-sm text-gray-500">
              Real CVE data from NVD, CISA KEV, and EPSS
            </p>
          </div>
          <button
            onClick={handleEnrich}
            disabled={isLoading || enrichableAssets.length === 0}
            className={`px-4 py-2 rounded-lg font-medium ${
              isLoading
                ? "bg-gray-300 cursor-not-allowed"
                : "bg-blue-600 hover:bg-blue-700 text-white"
            }`}
          >
            {isLoading ? (
              <span className="flex items-center gap-2">
                <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                  <circle
                    className="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                    fill="none"
                  />
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                  />
                </svg>
                Enriching... ({progress.current}/{progress.total})
              </span>
            ) : (
              `Enrich ${enrichableAssets.length} Assets`
            )}
          </button>
        </div>
      </div>

      {/* Error */}
      {error && (
        <div className="p-4 bg-red-50 text-red-700">
          Error: {error}
        </div>
      )}

      {/* Summary */}
      {summary && (
        <div className="p-4 border-b border-gray-200 dark:border-gray-700">
          <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <div className="text-center">
              <div className="text-2xl font-bold text-gray-900 dark:text-white">
                {summary.totalCVEs}
              </div>
              <div className="text-xs text-gray-500">Total CVEs</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-red-600">
                {summary.criticalCVEs}
              </div>
              <div className="text-xs text-gray-500">Critical</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-orange-600">
                {summary.highCVEs}
              </div>
              <div className="text-xs text-gray-500">High</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-purple-600">
                {summary.kevCVEs}
              </div>
              <div className="text-xs text-gray-500">In KEV (Exploited)</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-red-800">
                {summary.criticalAssets}
              </div>
              <div className="text-xs text-gray-500">Critical Assets</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-orange-800">
                {summary.highAssets}
              </div>
              <div className="text-xs text-gray-500">High Risk Assets</div>
            </div>
          </div>
        </div>
      )}

      {/* Asset List */}
      {enrichments.length > 0 && (
        <div className="p-4">
          <h4 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
            Vulnerability by Asset
          </h4>
          <div className="space-y-2 max-h-96 overflow-auto">
            {enrichments
              .sort((a, b) => {
                const tierOrder = { critical: 0, high: 1, medium: 2, low: 3 };
                return tierOrder[a.riskTier] - tierOrder[b.riskTier];
              })
              .map((enrichment) => (
                <div
                  key={enrichment.assetId}
                  onClick={() => setSelectedEnrichment(enrichment)}
                  className={`p-3 rounded-lg border cursor-pointer hover:shadow-md transition-shadow ${
                    TIER_COLORS[enrichment.riskTier]
                  }`}
                >
                  <div className="flex items-center justify-between">
                    <div>
                      <span className="font-mono font-bold">
                        {enrichment.tagNumber}
                      </span>
                      <span className="ml-2 text-sm opacity-75">
                        {enrichment.vendor} {enrichment.model}
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      {enrichment.kevCount > 0 && (
                        <span className="px-2 py-0.5 bg-purple-600 text-white text-xs rounded">
                          {enrichment.kevCount} KEV
                        </span>
                      )}
                      <span className="text-sm font-medium">
                        {enrichment.totalCVEs} CVEs
                      </span>
                      <span
                        className={`px-2 py-0.5 text-xs rounded ${
                          SEVERITY_COLORS[
                            enrichment.riskTier.toUpperCase() as keyof typeof SEVERITY_COLORS
                          ] || "bg-gray-200"
                        }`}
                      >
                        {enrichment.riskTier}
                      </span>
                    </div>
                  </div>
                  <div className="mt-1 flex gap-2 text-xs">
                    <span className="text-red-700">
                      {enrichment.criticalCount} critical
                    </span>
                    <span className="text-orange-700">
                      {enrichment.highCount} high
                    </span>
                    <span className="text-yellow-700">
                      {enrichment.mediumCount} medium
                    </span>
                    {enrichment.maxEPSS > 0 && (
                      <span className="text-purple-700">
                        EPSS: {(enrichment.maxEPSS * 100).toFixed(1)}%
                      </span>
                    )}
                  </div>
                </div>
              ))}
          </div>
        </div>
      )}

      {/* CVE Detail Modal */}
      {selectedEnrichment && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
            <div className="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
              <div>
                <h3 className="font-bold text-lg">
                  {selectedEnrichment.tagNumber}
                </h3>
                <p className="text-sm text-gray-500">
                  {selectedEnrichment.vendor} {selectedEnrichment.model}
                </p>
              </div>
              <button
                onClick={() => setSelectedEnrichment(null)}
                className="text-gray-400 hover:text-gray-600 text-2xl"
              >
                Ã—
              </button>
            </div>
            <div className="p-4 overflow-auto max-h-[60vh]">
              <h4 className="font-medium mb-2">
                Top CVEs ({selectedEnrichment.topCVEs.length})
              </h4>
              <div className="space-y-3">
                {selectedEnrichment.topCVEs.map((cve) => (
                  <div
                    key={cve.cveId}
                    className="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"
                  >
                    <div className="flex items-center justify-between mb-1">
                      <a
                        href={`https://nvd.nist.gov/vuln/detail/${cve.cveId}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="font-mono text-blue-600 hover:underline"
                      >
                        {cve.cveId}
                      </a>
                      <div className="flex items-center gap-2">
                        {cve.inKEV && (
                          <span className="px-2 py-0.5 bg-purple-600 text-white text-xs rounded">
                            KEV
                          </span>
                        )}
                        {cve.cvssV3Score && (
                          <span
                            className={`px-2 py-0.5 text-xs rounded ${
                              SEVERITY_COLORS[cve.cvssV3Severity || "LOW"]
                            }`}
                          >
                            {cve.cvssV3Score} {cve.cvssV3Severity}
                          </span>
                        )}
                        {cve.epssScore && (
                          <span className="px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded">
                            EPSS: {(cve.epssScore * 100).toFixed(1)}%
                          </span>
                        )}
                      </div>
                    </div>
                    <p className="text-sm text-gray-600 dark:text-gray-300">
                      {cve.description}
                    </p>
                    <div className="mt-1 text-xs text-gray-400">
                      Published: {cve.published}
                      {cve.attackVector && ` | Vector: ${cve.attackVector}`}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Empty State */}
      {!isLoading && enrichments.length === 0 && (
        <div className="p-8 text-center text-gray-500">
          <p className="mb-2">
            Click "Enrich" to fetch real vulnerability data for your assets.
          </p>
          <p className="text-sm">
            {enrichableAssets.length} assets have vendor information for CVE lookup.
          </p>
          <p className="text-xs mt-2 text-gray-400">
            Data sources: NVD, CISA KEV, FIRST EPSS
          </p>
        </div>
      )}
    </div>
  );
}
